worker_processes auto;

events {
    worker_connections 4096;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    client_max_body_size 0;
    proxy_read_timeout 3600;
    proxy_send_timeout 3600;

    upstream backend_auth {
        server backend:3000;
        keepalive 64;
    }

    upstream minio_private {
        server minio:9000;
        keepalive 64;
    }

    log_format media_json escape=json
        '{ "time":"$time_iso8601", "remote":"$remote_addr", "method":"$request_method",'
        ' "uri":"$request_uri", "status":$status,'
        ' "bytes":$body_bytes_sent, "range":"$http_range",'
        ' "upstream_status":"$upstream_status",'
        ' "req_time":$request_time, "up_time":"$upstream_response_time",'
        ' "user_agent":"$http_user_agent" }';

    access_log /var/log/nginx/media_access.log media_json;
    error_log /var/log/nginx/media_error.log warn;

    map $http_origin $cors_allow_origin {
        default "";
        "~^https?://localhost(:[0-9]+)?$" $http_origin;
        "~^https?://example\.com$" $http_origin;
    }

    #######################################################################
    # Common server configuration (applies to both 80 and 443)
    #######################################################################

    #----------------#
    # Port 80 Server #
    #----------------#
    server {
        listen 80;
        server_name media.example.com localhost;

        include /etc/nginx/conf.d/common_routes.conf;
    }

    #-----------------#
    # Port 443 Server #
    #-----------------#
    server {
        listen 443 ssl;
        http2 on;
        server_name media.example.com localhost;

        ssl_certificate /etc/nginx/certs/cert.pem;
        ssl_certificate_key /etc/nginx/certs/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        include /etc/nginx/conf.d/common_routes.conf;
    }
}
