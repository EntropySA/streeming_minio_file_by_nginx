# Auth subrequest endpoint - only validates JWT
location = /authz {
    internal;
    proxy_pass http://backend_auth/authz/media;
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Original-URI $request_uri;
    proxy_set_header X-Original-Method $request_method;
    proxy_set_header X-Forwarded-For $remote_addr;
}

# Direct streaming from MinIO with JWT auth
location /v1/audio/ {
    add_header Access-Control-Allow-Origin $cors_allow_origin always;
    add_header Vary Origin always;
    add_header Access-Control-Expose-Headers "accept-ranges, content-range, etag, last-modified, content-length" always;

    # Handle CORS preflight
    if ($request_method = OPTIONS) {
        add_header Access-Control-Allow-Origin $cors_allow_origin always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Range, If-Range, Content-Type" always;
        add_header Access-Control-Max-Age 3600 always;
        return 204;
    }

    # Authenticate request
    auth_request /authz;
    error_page 401 403 = @auth_error;

    # Rewrite and proxy to MinIO
    rewrite ^/v1/audio/(.*)$ /tasama-recordings/$1 break;
    proxy_pass http://minio_private;
    proxy_buffering off;
    proxy_request_buffering off;

    proxy_set_header Range $http_range;
    proxy_set_header If-Range $http_if_range;
    proxy_set_header Host $http_host;
    proxy_set_header Connection "";

    proxy_hide_header x-amz-id-2;
    proxy_hide_header x-amz-request-id;
    proxy_hide_header x-amz-server-side-encryption;
    proxy_hide_header x-amz-delete-marker;
    proxy_hide_header x-amz-version-id;

    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy no-referrer-when-downgrade always;

    proxy_http_version 1.1;
    proxy_set_header Accept-Encoding "";
}

# Auth error handler
location @auth_error {
    default_type application/json;
    add_header Content-Type application/json always;
    add_header Access-Control-Allow-Origin $cors_allow_origin always;
    return 403 '{"error":"forbidden","message":"Access denied"}';
}

# Backend API endpoints (login, upload, list)
location /auth/ {
    proxy_pass http://backend_auth;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    add_header Access-Control-Allow-Origin $cors_allow_origin always;
}

location /media/ {
    proxy_pass http://backend_auth;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    add_header Access-Control-Allow-Origin $cors_allow_origin always;
}

# Health check
location /health {
    access_log off;
    return 200 "OK\n";
    add_header Content-Type text/plain;
}
